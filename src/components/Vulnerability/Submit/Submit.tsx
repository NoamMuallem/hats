import SubmitSuccess, { BotStatus } from "./components/SubmitSuccess/SubmitSuccess";
import SubmitReview from "./components/SubmitReview/SubmitReview";
import { useState } from "react";
import { Dispatch } from "redux";
import axios from "axios";
import { toggleNotification } from "../../../actions";
import { NotificationType } from "../../../constants/constants";
import { Card, IVulnerabilityData } from "../types";
import "./index.scss";
import { DEFAULT_CLAIM_BOT } from "settings";

interface IProps {
  cards: IVulnerabilityData
  setCards: Function
}

/**
 * Function to call the Telegram bot after a success on the blockchain transaction.
 * @param {Function} submitCard 
 * @param {string} telegramBotUrl 
 * @param {string} encryptedData 
 * @param {string} transactionHash 
 * @param {boolean} isRouted 
 * @param {Function} setBotStatus 
 * @param {Dispatch} dispatch 
 */
export const onChainTransactionSuccess = async (submitCard: Function, telegramBotUrl: string, encryptedData: string, transactionHash: string, route: string | undefined, setBotStatus: Function, dispatch: Dispatch) => {
  try {
    const payload = {
      msg: encryptedData,
      txHash: transactionHash,
      route
    }
    setBotStatus(BotStatus.Pending);
    try {
      await axios.post(telegramBotUrl, payload);
    } catch (err) {
      console.error(err);
      // could not reach the defined bot, fall back to pre-defined bot
      await axios.post(DEFAULT_CLAIM_BOT, payload)
    }
    setBotStatus(BotStatus.Success);
    submitCard(Card.submission, Card.submission, { botStatus: BotStatus.Success });
    dispatch(toggleNotification(true, NotificationType.Success, "Bot success!"));
  } catch (error: any) {
    setBotStatus(BotStatus.Fail);
    submitCard(Card.submission, Card.submission, {
      botStatus: BotStatus.Fail,
      telegramBotUrl: telegramBotUrl,
      encryptedData: encryptedData,
      transactionHash: transactionHash,
    });
    dispatch(toggleNotification(true, NotificationType.Error, error?.message ?? "Bot failed!"));
    console.error(error);
  }
}

export default function Submit({ cards, setCards }: IProps) {
  const [botStatus, setBotStatus] = useState<BotStatus | undefined>(cards.submission.botStatus);

  return (
    <div className="submit-wrapper card-content">
      {cards.submission.verified ? (
        <SubmitSuccess
          setCards={setCards}
          cards={cards}
          botStatus={botStatus}
          setBotStatus={setBotStatus} />) : (
        <SubmitReview
          cards={cards}
          setBotStatus={setBotStatus} />)}
    </div>
  )
}
