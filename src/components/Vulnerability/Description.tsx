import React, { useState } from "react";
import "../../styles/Vulnerability/Description.scss";
import { AccordionContext, ICardData } from "./VulnerabilityAccordion";
import ReactMde from "react-mde";
import * as Showdown from "showdown";
import download from "downloadjs";
import classNames from "classnames";

interface IProps {
  cards: { [id: number]: ICardData }
}

type DescriptionTab = "write" | "preview";

const converter = new Showdown.Converter({
  tables: true,
  simplifiedAutoLink: true,
  strikethrough: true,
  tasklists: true
});

export default function Description(props: IProps) {
  const { cards } = props;
  const [title, setTitle] = useState(cards[3].data.title);
  const [selectedTab, setSelectedTab] = React.useState<DescriptionTab>("write");
  const [description, setDescription] = useState(cards[3].data.description);
  const { submitCard } = React.useContext(AccordionContext);
  const textToDownload = `
  **Project Name:** ${cards[1].data.projectName}
  **Title:** ${title}
  **Description:** ${description}
  **Telegram username:** ${cards[2].data.username}
  **Beneficiary:** ${cards[2].data.beneficiary}
  `;

  const titleInputClass = classNames({
    "inputError": title === ""
  })

  const descriptionInputClass = classNames({
    "inputError": description === ""
  })

  return (
    <div className="description-wrapper">
      <input className={titleInputClass} autoFocus type="text" placeholder="Title" onChange={(e) => setTitle(e.target.value)} value={title} />
      <ReactMde
        classes={{ textArea: descriptionInputClass }}
        value={description}
        onChange={setDescription}
        selectedTab={selectedTab}
        onTabChange={setSelectedTab}
        generateMarkdownPreview={markdown =>
          Promise.resolve(converter.makeHtml(markdown))
        } />

      <button
        disabled={title === "" || description === ""}
        onClick={() => {
          submitCard(3, { title: title, description: description });
          download(textToDownload, `${title}.md`);
        }}>SAVE AND DOWNLOAD</button>
    </div>
  )
}
